# Test Trigger (Verification)

These SQL snippets prove the trigger works.

## Test 1: 
The "Lazy" Insert (Auto-Calculation) We insert Spend, but NO Carbon. The DB should fix it.
```sql
-- Insert Spend of $1000 on Software (Factor ~0.02)
INSERT INTO fct_scope3_ledger 
(transaction_id, transaction_date, supplier_id, sector_code, spend_amount_usd, calculation_method)
VALUES 
('test-001', CURRENT_DATE, 'sup-01', 'Cloud & Software', 1000.00, 'SPEND_BASED');

-- Verify:
SELECT spend_amount_usd, calculated_co2e_kg FROM fct_scope3_ledger WHERE transaction_id = 'test-001';
-- Expected Result: Carbon should be ~20.00 (1000 * 0.02). NOT NULL.
```
---

## Test 2: 
The "Time Traveler" (Validation) We try to insert a date in 2050.
```sql
INSERT INTO fct_scope3_ledger 
(transaction_id, transaction_date, supplier_id, sector_code, spend_amount_usd, calculation_method)
VALUES 
('test-fail-01', '2050-01-01', 'sup-01', 'Cloud & Software', 100.00, 'SPEND_BASED');

-- Expected Result: SQL Error "Data Integrity Violation: Transaction Date... is in the future."
```
---

# Test Stored Procedures (Verification)

These SQL snippets prove the stored procedures work.

## Step 1: Create a Supplier (Success)

```sql
CALL sp_upsert_supplier(
    'sup-001', 'Acme Steel Co', 'US', 'Manufacturing', 5.0, 8.0
);
-- Result: row created in dim_suppliers
```
## Step 2: Try to Insert Transaction for MISSING Supplier (Fail)
```sql
CALL sp_upsert_transaction(
    'tx-999', 'batch-01', CURRENT_DATE, 'sup-999', 'Manufacturing', 100.00, 'SPEND_BASED'
);
-- Result: SQL Error "Integrity Error: Cannot insert... Supplier sup-999 does not exist."
```

## Step 3: Insert Valid Transaction (Success)
```sql
CALL sp_upsert_transaction(
    'tx-001', 'batch-01', CURRENT_DATE, 'sup-001', 'Manufacturing', 1000.00, 'SPEND_BASED'
);
-- Result: Success. 
-- Check table: calculated_co2e_kg should be populated (e.g. 2800 kg) by the Trigger.
```

## Step 4: Update the Spend (The Correction) Imagine we typed $1000 but it was actually $2000.
```sql
CALL sp_upsert_transaction(
    'tx-001', 'batch-01', CURRENT_DATE, 'sup-001', 'Manufacturing', 2000.00, 'SPEND_BASED'
);
-- Result: Success.
-- Check table: Spend is now 2000.00. Carbon should have doubled automatically.
```
---

